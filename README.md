# èªå¯ã®å®Ÿè£…ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ç¢ºèª

## å‚åŠ è€…ã®ç›®ç·šåˆã‚ã›
### èªå¯ãƒ¢ãƒ‡ãƒ«
#### RBAC

```python
# 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUserï¼‰
user = {
    "username": "alice",
    "role": "admin"
}

# 2. ãƒ­ãƒ¼ãƒ«åˆ¥æ¨©é™ï¼ˆRole-based Permissionsï¼‰
role_permissions = {
    "admin": {
        "users": ["read", "create", "update", "delete"],
        "shops": ["read", "create", "update", "delete"],
        "inquiries": ["read", "create", "update", "delete"],
        "corporations": ["read", "create", "update", "delete"]
    },
    "accountant": {
        "users": ["read"],
        "shops": [],  # ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
        "inquiries": [],  # ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
        "corporations": []  # ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
    }
}



```

#### ABACã¨ã¯

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒªã‚½ãƒ¼ã‚¹ã€ç’°å¢ƒã®æ§˜ã€…ãª**å±æ€§ï¼ˆAttributeï¼‰**ã‚’è©•ä¾¡

```python
# Userã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¾‹ï¼ˆå¤šæ§˜ãªå±æ€§ã‚’æŒã¤ï¼‰

user = {
    "username": "alice",
    "role": "admin",
    "corporation_id": 1,
    "employment_date": "2020-01-01",
    "region": "tokyo",
    "security_clearance": "confidential",
    "is_temporary": False
}

context = {
    "classification": "confidential",
}

## åˆ¤å®šæ¡ä»¶
user.employment_date < xxx
user.is_temporary == true

print(check_abac_permission(alice, "financial_reports", "read", context))  # True
print(check_abac_permission(alice, "sensitive_data", "read", context))     # Trueï¼ˆé›‡ç”¨æ—¥OKï¼‰

- **RBACã¯ABACã®ä¸€ç¨®**
- ã€Œroleå±æ€§ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ABACã€
```

#### ReBACï¼ˆRelationship-Based Access Control
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒªã‚½ãƒ¼ã‚¹é–“ã®é–¢ä¿‚æ€§ã§ã‚°ãƒ©ãƒ•ç†è«–ã§æ¨©é™æ±ºå®š
- æ¨©é™ã®å®šç¾©ãŒæ›¸ãã‚„ã™ã„
- ã‚µãƒ¼ãƒãŒå¿…è¦ã§å­¦ç¿’ã‚³ã‚¹ãƒˆã‚‚é«˜ã„ã®ã§ã€ä»Šå›ã¯å¤šåˆ†è¦‹é€ã‚Š



## ä»Šå›ã®è¦ä»¶
- èªè¨¼ã¨ã®åˆ†é›¢
- ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå‹ã®æ¨©é™è¨­è¨ˆ
  - Aä¼šç¤¾ã€Bä¼šç¤¾ã€Cä¼šç¤¾ãŒã‚ã£ã¦ã€ä¼šç¤¾ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã¯åˆ†é›¢ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ãªã‚‰ãªã„
  - ã‚ã‚‹ä¼šç¤¾ã‹ã‚‰åˆ¥ã®ä¼šç¤¾æƒ…å ±ãŒè¦‹ãˆã¦ã—ã¾ã†ã¨ä¿¡ç”¨ã«é–¢ã‚ã‚‹
    - DBå±¤ã§åˆ†é›¢ã§ããªã„
    - æ¨©é™åˆ¤å®šã§åˆ†é›¢ã™ã‚‹


## Casbin
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ä½¿ãˆã‚‹
- ã‚‚ã†Pythonã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ä½¿ãˆã‚‹ãƒ„ãƒ¼ãƒ«ã¯ã“ã‚Œãã‚‰ã„ã—ã‹ãªã„ã€‚
- ã“ã‚Œä»¥å¤–ã ã¨ã€ãƒãƒãƒ¼ã‚¸ãƒ‰ã«ã™ã‚‹ã‹ã€è‡ªå‰ã‚µãƒ¼ãƒãŒå¿…è¦


## ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹RBAC
- ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰åˆ¤å®š + RBAC



## è€ƒæ…®äº‹é …
- é–¢æ•°ï¼Ÿã‚¯ãƒ©ã‚¹ï¼Ÿ é–¢æ•°ã§ã„ã‘ãã†
- å˜ç´”ãªAllow/Denyä»¥å¤–ã®åˆ¶å¾¡ãŒå¿…è¦ã ã¨ã€crudå´ã§filter()ã¨ã‹ãŒå¿…è¦
- è¿½åŠ è¦ä»¶ ABACã§åˆ¥å®Ÿè£…ã€€crudå´? ç¥ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹ï¼Ÿ
- APIã®URLè¨­è¨ˆã«æ¡ä»¶ã‚ã‚Š
- 

# PyCasbin Domain-Based Multi-Tenant Authorization System

FastAPIã¨PyCasbinã‚’ä½¿ç”¨ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œRBACèªå¯ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ã§ã™ã€‚

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹Casbinã«ã‚ˆã‚‹é«˜é€Ÿãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆèªå¯ï¼š

```
ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ èªè¨¼(JWT) â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹RBACèªå¯ â†’ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‡¦ç†
                           â†“
                    enforce(user, domain, resource, action)
                           â†“
                    1å›ã®Casbinãƒã‚§ãƒƒã‚¯ã§å®Œçµ
```

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼ˆèªå¯ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ï¼‰

```
casbin_sample/
â”œâ”€â”€ ğŸ” èªå¯ã‚·ã‚¹ãƒ†ãƒ ã‚³ã‚¢
â”‚   â”œâ”€â”€ authorization_manager.py    # ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹èªå¯é–¢æ•°ç¾¤
â”‚   â””â”€â”€ casbin_config.py            # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹Casbinãƒ¢ãƒ‡ãƒ«ãƒ»ãƒãƒªã‚·ãƒ¼è¨­å®š
â”‚
â”œâ”€â”€ ğŸ”‘ èªè¨¼ãƒ»èªå¯è£œåŠ©
â”‚   â”œâ”€â”€ auth.py                     # JWTèªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”œâ”€â”€ casbin_rbac_auth.py         # ãƒ¬ã‚¬ã‚·ãƒ¼Casbiné–¢æ•°ï¼ˆéæ¨å¥¨ï¼‰
â”‚   â””â”€â”€ model.conf                  # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹Casbinãƒ¢ãƒ‡ãƒ«å®šç¾©
â”‚
â”œâ”€â”€ ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ users.py                # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ï¼ˆcorporation_idï¼‰
â”‚   â”‚   â”œâ”€â”€ roles.py                # ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ï¼ˆadmin, accountingï¼‰
â”‚   â”‚   â””â”€â”€ corporations.py         # æ³•äººãƒ¢ãƒ‡ãƒ«ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆï¼‰
â”‚   â””â”€â”€ casbin_rule                 # Casbinãƒãƒªã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«
â”‚
â””â”€â”€ ğŸŒ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    â””â”€â”€ routers/
        â”œâ”€â”€ inquiries.py             # å•ã„åˆã‚ã›ï¼ˆç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯ï¼‰
        â””â”€â”€ corporations.py          # æ³•äººè©³ç´°ï¼ˆç®¡ç†è€…ã®ã¿ã€çµŒç†ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰
```

